<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>مسابقة نافس – السؤال <span id="qNum">1</span></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#003865;--secondary:#1e8a4c;--accent:#ffce00;--light:#f5f7fa;--danger:#c62828}
    body{font-family:'Cairo',sans-serif;background:var(--light);margin:0;color:#222;display:flex;flex-direction:column;min-height:100vh}
    header{background:var(--primary);color:#fff;padding:.75rem 0;position:sticky;top:0;z-index:10}
    .container{width:90%;max-width:900px;margin:auto}
    .top-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .timer{font-size:1.2rem;background:var(--danger);padding:.25rem .75rem;border-radius:6px}
    .progress{width:100%;height:10px;background:#ffffff33;margin-top:.5rem;border-radius:5px;overflow:hidden}
    .progress span{display:block;height:100%;background:var(--accent);width:0%;transition:width .3s}
    main{flex:1;padding:2rem 0}
    .question-card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);padding:1.5rem}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .question-header span{background:var(--secondary);color:#fff;padding:.25rem .5rem;border-radius:6px;font-size:.8rem}
    .choices{display:flex;flex-direction:column;gap:.75rem;margin-top:1rem}
    .choices label{background:#fff;border:2px solid #ddd;border-radius:8px;padding:.75rem 1rem;cursor:pointer;transition:border .2s}
    .choices input{display:none}
    .choices input:checked+label{border-color:var(--secondary);background:#e8f5e9}
    .nav-buttons{display:flex;justify-content:space-between;margin-top:1.5rem}
    .nav-buttons button{padding:.5rem 1.25rem;border:none;border-radius:8px;cursor:pointer;font-size:1rem}
    .nav-buttons .prev{background:#9e9e9e;color:#fff}
    .nav-buttons .next{background:var(--secondary);color:#fff}
    .nav-buttons .exit{background:var(--danger);color:#fff}
    footer{text-align:center;padding:1rem 0;font-size:.8rem;color:#555}
    .debug-info{background:#fff3cd;border:1px solid #ffeaa7;padding:1rem;margin:1rem 0;border-radius:8px;font-size:0.9rem}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="top-bar">
        <div>مسابقة <b>نافس</b> – السؤال <span id="qNum">1</span> من <span id="totalQuestions">40</span></div>
        <div class="timer">الوقت المتبقي: <span id="count">45:00</span></div>
      </div>
      <div class="progress"><span id="bar"></span></div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="questionArea" class="question-card"></div>
      <!-- معلومات تصحيح الأخطاء (يمكن إزالتها في الإنتاج) -->
      <div class="debug-info" id="debugInfo" style="display:none;"></div>
      <div class="nav-buttons">
        <button class="prev" id="prevBtn" onclick="changeQuestion(-1)">السابق</button>
        <button class="exit" onclick="saveAndExit()">حفظ وخروج</button>
        <button class="next" id="nextBtn" onclick="changeQuestion(1)">التالي</button>
      </div>
    </div>
  </main>

  <footer>
    إشراف وتنفيذ: الأستاذ نواف الصبحي
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwmnuN3GmXh-Snj_SGXVYxvC4BoksHuts",
      authDomain: "naafis-platform.firebaseapp.com",
      projectId: "naafis-platform",
      storageBucket: "naafis-platform.firebasestorage.app",
      messagingSenderId: "337917395597",
      appId: "1:337917395597:web:6c90a2847ac51ed0c658c4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    let questions = [];
    let current   = 0;
    let answers   = {};
    let timeLeft  = 45 * 60;
    let debugMode = true; // تعيين إلى false في الإنتاج

    const student = JSON.parse(sessionStorage.getItem('student'));
    if (!student) location.href = 'login.html';

    // استعادة رقم السؤال إن وُجد
    const savedQ = sessionStorage.getItem('currentQ');
    if (savedQ) current = parseInt(savedQ);

    // مؤقت رئيسي
    const timer = setInterval(() => {
      timeLeft--;
      const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const s = String(timeLeft % 60).padStart(2, '0');
      document.getElementById('count').textContent = `${m}:${s}`;
      if (timeLeft <= 0) {
        clearInterval(timer);
        submitAll();
      }
    }, 1000);

    // دالة تصحيح الأخطاء
    function debugLog(message, data = null) {
      if (debugMode) {
        console.log(message, data);
        const debugDiv = document.getElementById('debugInfo');
        if (debugDiv) {
          debugDiv.style.display = 'block';
          debugDiv.innerHTML += `<div><strong>${message}</strong> ${data ? JSON.stringify(data) : ''}</div>`;
        }
      }
    }

    // تحميل الأسئلة المختارة (بالضبط 40)
    async function loadQuestions() {
      try {
        const snap = await db.collection('questions')
                             .where('weekId', '==', 'week1')
                             .where('selected', '==', true)
                             .get();
        
        questions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        questions = questions.slice(0, 40);           // بالضبط 40
        questions.sort(() => Math.random() - 0.5);   // خلط عشوائي

        debugLog('تم تحميل الأسئلة:', { count: questions.length });
        
        // تحقق من وجود correctIndex في كل سؤال
        questions.forEach((q, idx) => {
          debugLog(`السؤال ${idx + 1}:`, {
            id: q.id,
            hasCorrectIndex: q.correctIndex !== undefined,
            correctIndex: q.correctIndex,
            choicesCount: q.choices ? q.choices.length : 0
          });
        });

        // استرجاع إجابات محفوظة
        const savedSnap = await db.collection('answers_temp')
                                  .where('studentId', '==', student.id)
                                  .get();
        savedSnap.forEach(doc => {
          const d = doc.data();
          answers[d.qId] = parseInt(d.ans); // تأكد من أن الإجابة رقم صحيح
        });

        debugLog('الإجابات المحفوظة:', answers);
        renderQuestion();
      } catch (error) {
        console.error('خطأ في تحميل الأسئلة:', error);
        alert('حدث خطأ في تحميل الأسئلة، حاول مرة أخرى.');
      }
    }

    // عرض السؤال (بدون شرح وبدون اختيار تلقائي)
    function renderQuestion() {
      const q = questions[current];
      if (!q) {
        console.error('السؤال غير موجود:', current);
        return;
      }

      document.getElementById('qNum').textContent  = current + 1;
      document.getElementById('bar').style.width   = `${((current + 1) / 40) * 100}%`;
      document.getElementById('prevBtn').disabled  = current === 0;
      document.getElementById('nextBtn').textContent = current === 39 ? 'إرسال الإجابات' : 'التالي';

      // إفراغ أي اختيار سابق تماماً (منع التحديد التلقائي)
      document.querySelectorAll('input[name="q"]').forEach(inp => inp.checked = false);

      document.getElementById('questionArea').innerHTML = `
        <div class="question-header">
          <h3>السؤال ${current + 1} من 40</h3>
          <span>${q.subject === 'math' ? 'رياضيات' : q.subject === 'arabic' ? 'لغة عربية' : 'علوم'}</span>
        </div>
        <p>${q.questionText || 'نص السؤال غير متاح'}</p>
        <div class="choices">
          ${q.choices ? q.choices.map((ch, idx) => `
            <input type="radio" name="q" id="c${idx}" value="${idx}" ${answers[q.id] === idx ? 'checked' : ''}>
            <label for="c${idx}">${ch}</label>
          `).join('') : '<p>الخيارات غير متاحة</p>'}
        </div>
      `;

      debugLog(`عرض السؤال ${current + 1}:`, {
        questionId: q.id,
        correctIndex: q.correctIndex,
        studentAnswer: answers[q.id],
        hasChoices: !!q.choices
      });
    }

    async function changeQuestion(step) {
      // حفظ الإجابة الحالية
      const sel = document.querySelector('input[name="q"]:checked');
      if (sel) {
        const answerValue = parseInt(sel.value);
        answers[questions[current].id] = answerValue;
        debugLog(`تم حفظ الإجابة للسؤال ${current + 1}:`, {
          questionId: questions[current].id,
          answer: answerValue
        });
      }
      
      await saveTempAnswer();
      sessionStorage.setItem('currentQ', current);

      if (step === 1 && current === 39) {   // بالضبط 39 (السؤال الأخير)
        const sure = confirm('هل أنت متأكد من إرسال الإجابات؟');
        if (sure) {
          clearInterval(timer);
          await submitAll();
        }
        return;
      }
      current += step;
      renderQuestion();
    }

    async function saveTempAnswer() {
      const qId = questions[current].id;
      if (answers[qId] !== undefined) {
        try {
          const old = await db.collection('answers_temp')
                              .where('studentId', '==', student.id)
                              .where('qId', '==', qId)
                              .get();
          old.forEach(doc => doc.ref.delete());
          
          await db.collection('answers_temp').add({
            studentId: student.id,
            qId,
            ans: answers[qId], // تأكد من أنها رقم صحيح
            timeSeconds: (45 * 60) - timeLeft
          });
          
          debugLog('تم حفظ الإجابة مؤقتاً:', {
            qId,
            answer: answers[qId]
          });
        } catch (error) {
          console.error('خطأ في حفظ الإجابة المؤقتة:', error);
        }
      }
    }

    async function saveAndExit() {
      await saveTempAnswer();
      if (confirm('سيتم حفظ إجاباتك والخروج.. هل تريد المتابعة؟')) {
        clearInterval(timer);
        location.href = 'index.html';
      }
    }

    // دالة الإرسال النهائي (مع التأكد من الانتقال)
    async function submitAll() {
      try {
        debugLog('بدء الإرسال...');
        debugLog('الإجابات المحفوظة:', answers);

        let correctCount = 0;
        let totalAnswered = 0;
        
        // تحليل مفصل لكل سؤال
        questions.slice(0, 40).forEach((q, index) => {
          const studentAnswer = answers[q.id]; // قد تكون undefined أو رقم
          const correctAnswer = q.correctIndex; // الإجابة الصحيحة
          
          debugLog(`تحليل السؤال ${index + 1}:`, {
            questionId: q.id,
            studentAnswer: studentAnswer,
            correctAnswer: correctAnswer,
            studentAnswerType: typeof studentAnswer,
            correctAnswerType: typeof correctAnswer,
            isAnswered: studentAnswer !== undefined,
            isCorrect: studentAnswer !== undefined && studentAnswer === correctAnswer
          });

          if (studentAnswer !== undefined) {
            totalAnswered++;
            // تأكد من أن المقارنة تتم بنفس النوع
            if (parseInt(studentAnswer) === parseInt(correctAnswer)) {
              correctCount++;
              debugLog(`✅ إجابة صحيحة للسؤال ${index + 1}`);
            } else {
              debugLog(`❌ إجابة خاطئة للسؤال ${index + 1}`);
            }
          } else {
            debugLog(`⚪ لم يتم الإجابة على السؤال ${index + 1}`);
          }
        });

        debugLog('النتيجة النهائية:', {
          correctCount: correctCount,
          totalAnswered: totalAnswered,
          totalQuestions: 40
        });

        const timeSpent = (45 * 60) - timeLeft;

        // إرسال النتيجة إلى Firestore
        await db.collection('results').add({
          studentName: student.fullName,
          studentId: student.id,
          weekId: 'week1',
          correctCount: correctCount,
          totalAnswered: totalAnswered,
          timeSeconds: timeSpent,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        debugLog('تم إرسال النتيجة إلى Firebase');

        // حفظ النتيجة محلياً
        const resultData = {
          correctCount: correctCount,
          totalAnswered: totalAnswered,
          timeSeconds: timeSpent,
          weekId: 'week1'
        };
        
        sessionStorage.setItem('result', JSON.stringify(resultData));
        debugLog('تم حفظ النتيجة محلياً:', resultData);

        // الانتقال الفوري إلى صفحة النتائج
        location.href = 'result.html';

      } catch (error) {
        console.error('خطأ في الإرسال:', error);
        alert('حدث خطأ أثناء الإرسال، حاول مرة أخرى.');
      }
    }

    // تحديث معاملات السؤال
    async function updateItemAnalysis() {
      try {
        const allResults = await db.collection('results')
                                   .where('weekId', '==', 'week1')
                                   .get();
        const total = allResults.size;
        if (total < 5) return;
        
        const questionsSnap = await db.collection('questions')
                                      .where('weekId', '==', 'week1')
                                      .get();
        
        for (const qDoc of questionsSnap.docs) {
          const qId = qDoc.id;
          const correctIndex = qDoc.data().correctIndex;
          let correctCount = 0;
          let allAnswers = [];
          
          for (const resDoc of allResults.docs) {
            const studentId = resDoc.data().studentId;
            const tempSnap = await db.collection('answers_temp')
                                     .where('studentId', '==', studentId)
                                     .where('qId', '==', qId)
                                     .limit(1)
                                     .get();
            
            const answer = tempSnap.empty ? null : parseInt(tempSnap.docs[0].data().ans);
            if (answer === parseInt(correctIndex)) correctCount++;
            allAnswers.push({ 
              studentId, 
              answer, 
              totalScore: resDoc.data().correctCount 
            });
          }
          
          const difficulty = correctCount / total;
          allAnswers.sort((a, b) => b.totalScore - a.totalScore);
          const groupSize = Math.max(1, Math.ceil(total * 0.27));
          const upperCorrect = allAnswers.slice(0, groupSize)
                                       .filter(s => s.answer === parseInt(correctIndex)).length;
          const lowerCorrect = allAnswers.slice(-groupSize)
                                       .filter(s => s.answer === parseInt(correctIndex)).length;
          const discrimination = (upperCorrect - lowerCorrect) / groupSize;
          
          await db.collection('questions').doc(qId).update({ 
            difficulty, 
            discrimination 
          });
        }
      } catch (error) {
        console.error('خطأ في تحديث تحليل الأسئلة:', error);
      }
    }

    loadQuestions();
  </script>
</body>
</html>
