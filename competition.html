<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>مسابقة نافس – السؤال <span id="qNum">1</span></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#003865;--secondary:#1e8a4c;--accent:#ffce00;--light:#f5f7fa;--danger:#c62828}
    body{font-family:'Cairo',sans-serif;background:var(--light);margin:0;color:#222;display:flex;flex-direction:column;min-height:100vh}
    header{background:var(--primary);color:#fff;padding:.75rem 0;position:sticky;top:0;z-index:10}
    .container{width:90%;max-width:900px;margin:auto}
    .top-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .timer{font-size:1.2rem;background:var(--danger);padding:.25rem .75rem;border-radius:6px}
    .progress{width:100%;height:10px;background:#ffffff33;margin-top:.5rem;border-radius:5px;overflow:hidden}
    .progress span{display:block;height:100%;background:var(--accent);width:0%;transition:width .3s}
    main{flex:1;padding:2rem 0}
    .question-card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);padding:1.5rem}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .question-header span{background:var(--secondary);color:#fff;padding:.25rem .5rem;border-radius:6px;font-size:.8rem}
    .choices{display:flex;flex-direction:column;gap:.75rem;margin-top:1rem}
    .choices label{background:#fff;border:2px solid #ddd;border-radius:8px;padding:.75rem 1rem;cursor:pointer;transition:border .2s}
    .choices input{display:none}
    .choices input:checked+label{border-color:var(--secondary);background:#e8f5e9}
    .nav-buttons{display:flex;justify-content:space-between;margin-top:1.5rem}
    .nav-buttons button{padding:.5rem 1.25rem;border:none;border-radius:8px;cursor:pointer;font-size:1rem}
    .nav-buttons .prev{background:#9e9e9e;color:#fff}
    .nav-buttons .next{background:var(--secondary);color:#fff}
    .nav-buttons .exit{background:var(--danger);color:#fff}
    footer{text-align:center;padding:1rem 0;font-size:.8rem;color:#555}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="top-bar">
        <div>مسابقة <b>نافس</b> – السؤال <span id="qNum">1</span> من <span id="totalQuestions">40</span></div>
        <div class="timer">الوقت المتبقي: <span id="count">45:00</span></div>
      </div>
      <div class="progress"><span id="bar"></span></div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="questionArea" class="question-card"></div>
      <div class="nav-buttons">
        <button class="prev" id="prevBtn" onclick="changeQuestion(-1)">السابق</button>
        <button class="exit" onclick="saveAndExit()">حفظ وخروج</button>
        <button class="next" id="nextBtn" onclick="changeQuestion(1)">التالي</button>
      </div>
    </div>
  </main>

  <footer>
    إشراف وتنفيذ: الأستاذ نواف الصبحي
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwmnuN3GmXh-Snj_SGXVYxvC4BoksHuts",
      authDomain: "naafis-platform.firebaseapp.com",
      projectId: "naafis-platform",
      storageBucket: "naafis-platform.firebasestorage.app",
      messagingSenderId: "337917395597",
      appId: "1:337917395597:web:6c90a2847ac51ed0c658c4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    let questions = [];
    let current   = 0;
    let answers   = {};
    let timeLeft  = 45 * 60;

    const student = JSON.parse(sessionStorage.getItem('student'));
    if (!student) location.href = 'login.html';

    // استعادة رقم السؤال إن وُجد
    const savedQ = sessionStorage.getItem('currentQ');
    if (savedQ) current = parseInt(savedQ);

    // مؤقت رئيسي
    const timer = setInterval(() => {
      timeLeft--;
      const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const s = String(timeLeft % 60).padStart(2, '0');
      document.getElementById('count').textContent = `${m}:${s}`;
      if (timeLeft <= 0) {
        clearInterval(timer);
        submitAll();
      }
    }, 1000);

    // تحميل الأسئلة المختارة (بالضبط ٤٠)
    async function loadQuestions() {
      const snap = await db.collection('questions')
                           .where('weekId', '==', 'week1')
                           .where('selected', '==', true)
                           .get();
      questions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      questions = questions.slice(0, 40);           // ← بالضبط ٤٠
      questions.sort(() => Math.random() - 0.5);   // خلط عشوائي

      // استرجاع إجابات محفوظة
      const savedSnap = await db.collection('answers_temp')
                                .where('studentId', '==', student.id)
                                .get();
      savedSnap.forEach(doc => {
        const d = doc.data();
        answers[d.qId] = d.ans;
      });

      renderQuestion();
    }

    // عرض السؤال (بدون شرح وبدون اختيار تلقائي)
    function renderQuestion() {
      const q = questions[current];
      document.getElementById('qNum').textContent  = current + 1;
      document.getElementById('bar').style.width   = `${((current + 1) / 40) * 100}%`;
      document.getElementById('prevBtn').disabled  = current === 0;
      document.getElementById('nextBtn').textContent = current === 39 ? 'إرسال الإجابات' : 'التالي';

      // ✅ إفراغ أي اختيار سابق (منع التحديد التلقائي)
      document.querySelectorAll('input[name="q"]').forEach(inp => inp.checked = false);

      document.getElementById('questionArea').innerHTML = `
        <div class="question-header">
          <h3>السؤال ${current + 1} من ٤٠</h3>
          <span>${q.subject === 'math' ? 'رياضيات' : q.subject === 'arabic' ? 'لغة عربية' : 'علوم'}</span>
        </div>
        <p>${q.questionText}</p>
        <div class="choices">
          ${q.choices.map((ch, idx) => `
            <input type="radio" name="q" id="c${idx}" value="${idx}" ${answers[q.id] === idx ? 'checked' : ''}>
            <label for="c${idx}">${ch}</label>
          `).join('')}
        </div>
      `;
    }

    async function changeQuestion(step) {
      const sel = document.querySelector('input[name="q"]:checked');
      if (sel) answers[questions[current].id] = parseInt(sel.value);
      await saveTempAnswer();
      sessionStorage.setItem('currentQ', current);

      if (step === 1 && current === 39) {
        const sure = confirm('هل أنت متأكد من إرسال الإجابات؟');
        if (sure) { clearInterval(timer); await submitAll(); }
        return;
      }
      current += step;
      renderQuestion();
    }

    async function saveTempAnswer() {
      const qId = questions[current].id;
      if (answers[qId] !== undefined) {
        const old = await db.collection('answers_temp')
                            .where('studentId', '==', student.id)
                            .where('qId', '==', qId)
                            .get();
        old.forEach(doc => doc.ref.delete());
        await db.collection('answers_temp').add({
          studentId: student.id,
          qId,
          ans: answers[qId],
          timeSeconds: (45 * 60) - timeLeft
        });
      }
    }

    async function submitAll() {
      let correctCount = 0;
      questions.slice(0, 40).forEach(q => {          // ← بالضبط ٤٠
        if (answers[q.id] === q.correctIndex) correctCount++;
      });
      const timeSpent = (45 * 60) - timeLeft;
      await db.collection('results').add({
        studentName: student.fullName,
        weekId: 'week1',
        correctCount,
        timeSeconds: timeSpent,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      const tempSnap = await db.collection('answers_temp')
                               .where('studentId', '==', student.id)
                               .get();
      tempSnap.forEach(doc => doc.ref.delete());
      await updateItemAnalysis();
      sessionStorage.setItem('result', JSON.stringify({
        correctCount,
        timeSeconds: timeSpent,
        weekId: 'week1'
      }));
      location.href = 'result.html';
    }

    // تحديث معاملات السؤال
    async function updateItemAnalysis() {
      const allResults = await db.collection('results')
                                 .where('weekId', '==', 'week1')
                                 .get();
      const total = allResults.size;
      if (total < 5) return;
      const questionsSnap = await db.collection('questions')
                                    .where('weekId', '==', 'week1')
                                    .get();
      for (const qDoc of questionsSnap.docs) {
        const qId = qDoc.id;
        const correctIndex = qDoc.data().correctIndex;
        let correctCount = 0;
        let allAnswers = [];
        for (const resDoc of allResults.docs) {
          const studentName = resDoc.data().studentName;
          const tempSnap = await db.collection('answers_temp')
                                   .where('studentId', '==', studentName)
                                   .where('qId', '==', qId)
                                   .limit(1)
                                   .get();
          const answer = tempSnap.empty ? null : tempSnap.docs[0].data().ans;
          if (answer === correctIndex) correctCount++;
          allAnswers.push({ studentName, answer, totalScore: resDoc.data().correctCount });
        }
        const difficulty = correctCount / total;
        allAnswers.sort((a, b) => b.totalScore - a.totalScore);
        const groupSize = Math.max(1, Math.ceil(total * 0.27));
        const upperCorrect = allAnswers.slice(0, groupSize).filter(s => s.answer === correctIndex).length;
        const lowerCorrect = allAnswers.slice(-groupSize).filter(s => s.answer === correctIndex).length;
        const discrimination = (upperCorrect - lowerCorrect) / groupSize;
        await db.collection('questions').doc(qId).update({ difficulty, discrimination });
      }
    }

    loadQuestions();
  </script>
</body>
</html>
