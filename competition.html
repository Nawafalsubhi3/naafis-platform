<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>مسابقة نافس – الأسئلة</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#003865;
      --secondary:#1e8a4c;
      --accent:#ffce00;
      --light:#f5f7fa;
      --danger:#c62828
    }
    body{font-family:'Cairo',sans-serif;background:var(--light);margin:0;color:#222}
    header{background:var(--primary);color:#fff;padding:.75rem 0;position:sticky;top:0;z-index:10}
    .container{width:90%;max-width:1000px;margin:auto}
    .top-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .timer{font-size:1.2rem;background:var(--danger);padding:.25rem .75rem;border-radius:6px}
    .progress{width:100%;height:8px;background:#ffffff33;margin-top:.5rem;border-radius:4px;overflow:hidden}
    .progress span{display:block;height:100%;background:var(--accent);width:0%;transition:width .3s}
    main{padding:2rem 0}
    .question-card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);padding:1.5rem;margin-bottom:1.25rem}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .question-header span{background:var(--secondary);color:#fff;padding:.25rem .5rem;border-radius:6px;font-size:.8rem}
    .explanation{background:#e8f5e9;border-right:4px solid var(--secondary);padding:.5rem .75rem;margin:.5rem 0;font-size:.9rem;color:#155724}
    .choices{display:flex;flex-direction:column;gap:.75rem;margin-top:1rem}
    .choices label{background:#fff;border:2px solid #ddd;border-radius:8px;padding:.75rem 1rem;cursor:pointer;transition:border .2s}
    .choices input{display:none}
    .choices input:checked+label{border-color:var(--secondary);background:#e8f5e9}
    .submit-btn{background:var(--secondary);color:#fff;border:none;padding:.75rem 2.5rem;font-size:1.1rem;border-radius:8px;cursor:pointer;display:block;margin:2rem auto 0}
    .submit-btn:disabled{background:#9e9e9e;cursor:not-allowed}
    footer{text-align:center;padding:1rem 0;font-size:.8rem;color:#555}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="top-bar">
        <div>مسابقة <b>نافس</b> – الصف الثالث المتوسط</div>
        <div class="timer">الوقت المتبقي: <span id="count">30:00</span></div>
      </div>
      <div class="progress"><span id="bar"></span></div>
    </div>
  </header>

  <main>
    <div class="container">
      <form id="quizForm"></form>
      <button id="submitBtn" class="submitBtn">إرسال الإجابات</button>
    </div>
  </main>

  <footer>
    إشراف وتنفيذ: الأستاذ نواف الصبحي | وزارة التعليم – مكتب تعليم العوالي
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwmnuN3GmXh-Snj_SGXVYxvC4BoksHuts",
      authDomain: "naafis-platform.firebaseapp.com",
      projectId: "naafis-platform",
      storageBucket: "naafis-platform.firebasestorage.app",
      messagingSenderId: "337917395597",
      appId: "1:337917395597:web:6c90a2847ac51ed0c658c4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    let timeLeft = 30 * 60; // 30 دقيقة بالثواني
    let correct = 0;
    const timer = setInterval(()=>{
      timeLeft--;
      const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
      const s = String(timeLeft%60).padStart(2,'0');
      document.getElementById('count').textContent = `${m}:${s}`;
      if(timeLeft<=0){clearInterval(timer); submitQuiz();}
    },1000);

    async function loadQuestions(){
      const snap = await db.collection('questions').where('weekId','==','week1').get();
      const qs = snap.docs.map(d=>({id:d.id,...d.data()}));
      const form = document.getElementById('quizForm');
      qs.forEach((q,i)=>{
        const block = document.createElement('div');
        block.className = 'question-card';
        block.innerHTML = `
          <div class="question-header">
            <h3>السؤال ${i+1} من 40</h3>
            <span>${q.subject==='math'?'رياضيات':q.subject==='arabic'?'لغة عربية':'علوم'}</span>
          </div>
          <p>${q.questionText}</p>
          <div class="explanation">${q.explanation}</div>
          <div class="choices">
            ${q.choices.map((ch,idx)=>`
              <input type="radio" name="q${q.id}" id="q${q.id}_${idx}" value="${idx}">
              <label for="q${q.id}_${idx}">${ch}</label>
            `).join('')}
          </div>
        `;
        form.appendChild(block);
      });
      updateProgress();
    }
    function updateProgress(){
      const total = document.querySelectorAll('input[type=radio]').length/4;
      let answered = 0;
      document.querySelectorAll('input[type=radio]').forEach(inp=>{if(inp.checked)answered++});
      document.getElementById('bar').style.width = `${(answered/total)*100}%`;
    }
    document.getElementById('quizForm').addEventListener('change',updateProgress);

    async function submitQuiz(){
      clearInterval(timer);
      const student = JSON.parse(sessionStorage.getItem('student'));
      const snap = await db.collection('questions').where('weekId','==','week1').get();
      let correctCount = 0;
      snap.forEach(doc=>{
        const q = doc.data();
        const sel = document.querySelector(`input[name="q${doc.id}"]:checked`);
        if(sel && parseInt(sel.value) === q.correctIndex) correctCount++;
      });
      const timeSpent = (30*60) - timeLeft;
      await db.collection('results').add({
        studentName: student.fullName,
        weekId: 'week1',
        correctCount,
        timeSeconds: timeSpent,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      sessionStorage.setItem('result', JSON.stringify({correctCount, timeSeconds: timeSpent, weekId:'week1'}));
      location.href = 'result.html';
    }
    document.getElementById('submitBtn').addEventListener('click', submitQuiz);

    loadQuestions();
  </script>
</body>
</html>
