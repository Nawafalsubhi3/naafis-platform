<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>مسابقة نافس – السؤال <span id="qNum">1</span></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#003865;--secondary:#1e8a4c;--accent:#ffce00;--light:#f5f7fa;--danger:#c62828}
    body{font-family:'Cairo',sans-serif;background:var(--light);margin:0;color:#222;display:flex;flex-direction:column;min-height:100vh}
    header{background:var(--primary);color:#fff;padding:.75rem 0;position:sticky;top:0;z-index:10}
    .container{width:90%;max-width:900px;margin:auto}
    .top-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .timer{font-size:1.2rem;background:var(--danger);padding:.25rem .75rem;border-radius:6px}
    .progress{width:100%;height:10px;background:#ffffff33;margin-top:.5rem;border-radius:5px;overflow:hidden}
    .progress span{display:block;height:100%;background:var(--accent);width:0%;transition:width .3s}
    main{flex:1;padding:2rem 0}
    .question-card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);padding:1.5rem}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .question-header span{background:var(--secondary);color:#fff;padding:.25rem .5rem;border-radius:6px;font-size:.8rem}
    .choices{display:flex;flex-direction:column;gap:.75rem;margin-top:1rem}
    .choices label{background:#fff;border:2px solid #ddd;border-radius:8px;padding:.75rem 1rem;cursor:pointer;transition:border .2s}
    .choices input{display:none}
    .choices input:checked+label{border-color:var(--secondary);background:#e8f5e9}
    .nav-buttons{display:flex;justify-content:space-between;margin-top:1.5rem}
    .nav-buttons button{padding:.5rem 1.25rem;border:none;border-radius:8px;cursor:pointer;font-size:1rem}
    .nav-buttons .prev{background:#9e9e9e;color:#fff}
    .nav-buttons .next{background:var(--secondary);color:#fff}
    .nav-buttons .exit{background:var(--danger);color:#fff}
    footer{text-align:center;padding:1rem 0;font-size:.8rem;color:#555}
    .debug-info{background:#fff3cd;border:1px solid #ffeaa7;padding:1rem;margin:1rem 0;border-radius:8px;font-size:0.9rem;display:none}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="top-bar">
        <div>مسابقة <b>نافس</b> – السؤال <span id="qNum">1</span> من <span id="totalQuestions">40</span></div>
        <div class="timer">الوقت المتبقي: <span id="count">45:00</span></div>
      </div>
      <div class="progress"><span id="bar"></span></div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="questionArea" class="question-card"></div>
      <div class="debug-info" id="debugInfo"></div>
      <div class="nav-buttons">
        <button class="prev" id="prevBtn" onclick="changeQuestion(-1)">السابق</button>
        <button class="exit" onclick="saveAndExit()">حفظ وخروج</button>
        <button class="next" id="nextBtn" onclick="changeQuestion(1)">التالي</button>
      </div>
    </div>
  </main>

  <footer>
    إشراف وتنفيذ: الأستاذ نواف الصبحي
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // متغيرات عامة
    let db;
    let isFirebaseReady = false;
    let questions = [];
    let current = 0;
    let answers = {};
    let timeLeft = 45 * 60;
    let debugMode = true;
    let student = null;

    // بديل آمن لـ sessionStorage
    function setStorage(key, value) {
      try {
        if (typeof sessionStorage !== 'undefined') {
          sessionStorage.setItem(key, value);
        } else {
          window.tempStorage = window.tempStorage || {};
          window.tempStorage[key] = value;
        }
      } catch (error) {
        window.tempStorage = window.tempStorage || {};
        window.tempStorage[key] = value;
      }
    }

    function getStorage(key) {
      try {
        if (typeof sessionStorage !== 'undefined') {
          return sessionStorage.getItem(key);
        } else {
          return window.tempStorage ? window.tempStorage[key] : null;
        }
      } catch (error) {
        return window.tempStorage ? window.tempStorage[key] : null;
      }
    }

    // دالة تصحيح الأخطاء
    function debugLog(message, data = null) {
      if (debugMode) {
        console.log(message, data);
        const debugDiv = document.getElementById('debugInfo');
        if (debugDiv) {
          debugDiv.style.display = 'block';
          debugDiv.innerHTML += '<div><strong>' + message + '</strong> ' + (data ? JSON.stringify(data) : '') + '</div>';
        }
      }
    }

    // تهيئة Firebase
    function initializeFirebase() {
      try {
        if (typeof window.firebase === 'undefined') {
          debugLog('Firebase لم يتم تحميله بعد، سأعيد المحاولة...');
          setTimeout(initializeFirebase, 200);
          return;
        }
        
        const firebaseConfig = {
          apiKey: "AIzaSyCwmnuN3GmXh-Snj_SGXVYxvC4BoksHuts",
          authDomain: "naafis-platform.firebaseapp.com",
          projectId: "naafis-platform",
          storageBucket: "naafis-platform.firebasestorage.app",
          messagingSenderId: "337917395597",
          appId: "1:337917395597:web:6c90a2847ac51ed0c658c4"
        };
        
        if (!window.firebase.apps.length) {
          window.firebase.initializeApp(firebaseConfig);
        }
        db = window.firebase.firestore();
        isFirebaseReady = true;
        debugLog('✅ تم تهيئة Firebase بنجاح');
        
        initializeApp();
      } catch (error) {
        debugLog('❌ خطأ في تهيئة Firebase: ' + error.message);
        isFirebaseReady = false;
        initializeApp();
      }
    }

    function initializeApp() {
      // إعداد بيانات الطالب
      const studentData = getStorage('student');
      if (studentData) {
        try {
          student = JSON.parse(studentData);
        } catch (error) {
          student = { id: 'test_student', fullName: 'طالب تجريبي' };
        }
      } else {
        student = { id: 'test_student', fullName: 'طالب تجريبي' };
      }

      // استعادة السؤال الحالي
      const savedQ = getStorage('currentQ');
      if (savedQ) {
        current = parseInt(savedQ);
      }

      startTimer();
      loadQuestions();
    }

    function startTimer() {
      const timer = setInterval(function() {
        timeLeft--;
        const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
        const s = String(timeLeft % 60).padStart(2, '0');
        const countElement = document.getElementById('count');
        if (countElement) {
          countElement.textContent = m + ':' + s;
        }
        if (timeLeft <= 0) {
          clearInterval(timer);
          submitAll();
        }
      }, 1000);
    }

    // تحميل الأسئلة
    async function loadQuestions() {
      try {
        // أسئلة تجريبية للاختبار
        questions = [];
        for (let i = 0; i < 40; i++) {
          questions.push({
            id: 'q_' + (i + 1),
            questionText: 'هذا السؤال رقم ' + (i + 1) + ' - ما هو الخيار الصحيح؟',
            choices: ['الخيار الأول', 'الخيار الثاني', 'الخيار الثالث', 'الخيار الرابع'],
            correctIndex: Math.floor(Math.random() * 4),
            subject: ['math', 'arabic', 'science'][i % 3]
          });
        }

        // خلط عشوائي
        questions.sort(function() { return Math.random() - 0.5; });

        debugLog('تم تحميل الأسئلة:', { count: questions.length });
        renderQuestion();
      } catch (error) {
        debugLog('خطأ في تحميل الأسئلة:', error.message);
        renderQuestion();
      }
    }

    // عرض السؤال
    function renderQuestion() {
      const q = questions[current];
      if (!q) {
        debugLog('السؤال غير موجود:', current);
        return;
      }

      const qNumElement = document.getElementById('qNum');
      const barElement = document.getElementById('bar');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (qNumElement) qNumElement.textContent = current + 1;
      if (barElement) barElement.style.width = ((current + 1) / 40) * 100 + '%';
      if (prevBtn) prevBtn.disabled = current === 0;
      if (nextBtn) nextBtn.textContent = current === 39 ? 'إرسال الإجابات' : 'التالي';

      const questionArea = document.getElementById('questionArea');
      if (questionArea) {
        let choicesHtml = '';
        if (q.choices) {
          for (let idx = 0; idx < q.choices.length; idx++) {
            const isChecked = answers[q.id] === idx ? 'checked' : '';
            choicesHtml += '<input type="radio" name="q" id="c' + idx + '" value="' + idx + '" ' + isChecked + '>';
            choicesHtml += '<label for="c' + idx + '">' + q.choices[idx] + '</label>';
          }
        }

        questionArea.innerHTML = 
          '<div class="question-header">' +
            '<h3>السؤال ' + (current + 1) + ' من 40</h3>' +
            '<span>' + (q.subject === 'math' ? 'رياضيات' : q.subject === 'arabic' ? 'لغة عربية' : 'علوم') + '</span>' +
          '</div>' +
          '<p>' + (q.questionText || 'نص السؤال غير متاح') + '</p>' +
          '<div class="choices">' + choicesHtml + '</div>';
      }

      debugLog('عرض السؤال ' + (current + 1) + ':', {
        questionId: q.id,
        correctIndex: q.correctIndex,
        studentAnswer: answers[q.id]
      });
    }

    // تغيير السؤال
    async function changeQuestion(step) {
      const sel = document.querySelector('input[name="q"]:checked');
      if (sel) {
        const answerValue = parseInt(sel.value);
        answers[questions[current].id] = answerValue;
        debugLog('تم حفظ الإجابة للسؤال ' + (current + 1) + ':', {
          questionId: questions[current].id,
          answer: answerValue
        });
      }
      
      setStorage('currentQ', current.toString());

      if (step === 1 && current === 39) {
        const sure = confirm('هل أنت متأكد من إرسال الإجابات؟');
        if (sure) {
          await submitAll();
        }
        return;
      }
      current += step;
      renderQuestion();
    }

    // حفظ والخروج
    async function saveAndExit() {
      if (confirm('سيتم حفظ إجاباتك والخروج.. هل تريد المتابعة؟')) {
        try {
          window.location.href = 'index.html';
        } catch (error) {
          alert('تم حفظ الإجابات بنجاح');
        }
      }
    }

    // إرسال جميع الإجابات
    async function submitAll() {
      try {
        debugLog('بدء الإرسال...');
        debugLog('الإجابات المحفوظة:', answers);

        let correctCount = 0;
        let totalAnswered = 0;
        
        for (let index = 0; index < questions.length && index < 40; index++) {
          const q = questions[index];
          const studentAnswer = answers[q.id];
          const correctAnswer = q.correctIndex;
          
          debugLog('تحليل السؤال ' + (index + 1) + ':', {
            questionId: q.id,
            studentAnswer: studentAnswer,
            correctAnswer: correctAnswer,
            isAnswered: studentAnswer !== undefined,
            isCorrect: studentAnswer !== undefined && parseInt(studentAnswer) === parseInt(correctAnswer)
          });

          if (studentAnswer !== undefined) {
            totalAnswered++;
            if (parseInt(studentAnswer) === parseInt(correctAnswer)) {
              correctCount++;
              debugLog('✅ إجابة صحيحة للسؤال ' + (index + 1));
            } else {
              debugLog('❌ إجابة خاطئة للسؤال ' + (index + 1));
            }
          } else {
            debugLog('⚪ لم يتم الإجابة على السؤال ' + (index + 1));
          }
        }

        debugLog('النتيجة النهائية:', {
          correctCount: correctCount,
          totalAnswered: totalAnswered,
          totalQuestions: 40
        });

        const timeSpent = (45 * 60) - timeLeft;

        // حفظ النتيجة محلياً
        const resultData = {
          correctCount: correctCount,
          totalAnswered: totalAnswered,
          timeSeconds: timeSpent,
          weekId: 'week1'
        };
        
        setStorage('result', JSON.stringify(resultData));
        debugLog('تم حفظ النتيجة محلياً:', resultData);

        // عرض النتيجة
        alert('انتهت المسابقة!\nالنتيجة: ' + correctCount + ' من 40\nالوقت المستغرق: ' + Math.floor(timeSpent / 60) + ' دقيقة و ' + (timeSpent % 60) + ' ثانية');

        // الانتقال لصفحة النتائج
        try {
          window.location.href = 'result.html';
        } catch (error) {
          debugLog('لا يمكن الانتقال إلى صفحة النتائج');
        }

      } catch (error) {
        debugLog('خطأ في الإرسال:', error.message);
        alert('حدث خطأ أثناء الإرسال، لكن تم حفظ النتيجة محلياً');
      }
    }

    // بدء التطبيق
    window.addEventListener('load', function() {
      debugLog('تم تحميل الصفحة، بدء التهيئة...');
      setTimeout(initializeFirebase, 500);
    });

    // إتاحة الدوال للنطاق العام
    window.changeQuestion = changeQuestion;
    window.saveAndExit = saveAndExit;
    window.submitAll = submitAll;
  </script>
</body>
</html>
