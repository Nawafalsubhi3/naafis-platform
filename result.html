<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ù†ØªÙŠØ¬ØªÙƒ â€“ Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø§ÙØ³</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#003865;--secondary:#1e8a4c;--accent:#ffce00;--light:#f5f7fa;--danger:#c62828}
    body{font-family:'Cairo',sans-serif;background:var(--light);margin:0;color:#222;display:flex;flex-direction:column;min-height:100vh;text-align:center}
    header{background:var(--primary);color:#fff;padding:1rem 0}
    .container{width:90%;max-width:600px;margin:auto}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);padding:2rem;margin:2rem 0}
    .score{font-size:3rem;color:var(--secondary);margin:.5rem 0}
    .score.excellent{color:var(--secondary)}
    .score.good{color:#ff9800}
    .score.needs-improvement{color:var(--danger)}
    .top3{list-style:none;padding:0;margin:1rem 0}
    .top3 li{background:var(--accent);color:#000;padding:.5rem 1rem;border-radius:8px;margin:.5rem 0;font-weight:700}
    footer{background:var(--primary);color:#fff;text-align:center;padding:1rem 0;font-size:.8rem;margin-top:auto}
    .btn{background:var(--secondary);color:#fff;border:none;padding:.75rem 2rem;border-radius:8px;cursor:pointer;font-size:1.1rem}
    .btn:hover{background:#166a3a}
    .performance-indicator{padding:1rem;border-radius:8px;margin:1rem 0}
    .performance-indicator.excellent{background:#e8f5e9;border:2px solid var(--secondary)}
    .performance-indicator.good{background:#fff3e0;border:2px solid #ff9800}
    .performance-indicator.needs-improvement{background:#ffebee;border:2px solid var(--danger)}
    .debug-section{background:#f8f9fa;border:1px solid #dee2e6;padding:1rem;margin:1rem 0;border-radius:8px;font-size:0.9rem;text-align:right}
    .loading{text-align:center;padding:2rem}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Ù†ØªÙŠØ¬ØªÙƒ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø§ÙØ³</h1>
      <p>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€“ Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ</p>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h2>Ù†ØªÙŠØ¬ØªÙƒ ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
      <div class="score" id="yourScore">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <p id="scoreDescription">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø£ØµÙ„ 40 Ø³Ø¤Ø§Ù„Ø§Ù‹</p>
      <div id="performanceIndicator" class="performance-indicator" style="display:none;">
        <h3 id="performanceTitle"></h3>
        <p id="performanceMessage"></p>
      </div>
      <div id="timeInfo" style="display:none;">
        <p><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚:</strong> <span id="timeSpent"></span></p>
      </div>
      <button class="btn" onclick="goHome()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div class="card">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù â€“ Ø£ÙØ¶Ù„ 3 Ø·Ù„Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>
      <div id="leaderboardLoading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù...</div>
      <ol class="top3" id="top3" style="display:none;"></ol>
      <div id="leaderboardError" style="display:none;">
        <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù Ø­Ø§Ù„ÙŠØ§Ù‹</p>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
    <div id="debugSection" class="debug-section" style="display:none;">
      <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
      <div id="debugInfo"></div>
    </div>
  </main>

  <footer>
    Ø¥Ø´Ø±Ø§Ù ÙˆØªÙ†ÙÙŠØ°: Ø§Ù„Ø£Ø³ØªØ§Ø° Ù†ÙˆØ§Ù Ø§Ù„ØµØ¨Ø­ÙŠ
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    let firebase, db;
    let isFirebaseReady = false;
    let debugMode = true; // ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ false ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬

    function initializeFirebase() {
      try {
        if (typeof firebase === 'undefined') {
          console.log('Firebase Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ØŒ Ø³Ø£Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
          setTimeout(initializeFirebase, 100);
          return;
        }
        
        const firebaseConfig = {
          apiKey: "AIzaSyCwmnuN3GmXh-Snj_SGXVYxvC4BoksHuts",
          authDomain: "naafis-platform.firebaseapp.com",
          projectId: "naafis-platform",
          storageBucket: "naafis-platform.firebasestorage.app",
          messagingSenderId: "337917395597",
          appId: "1:337917395597:web:6c90a2847ac51ed0c658c4"
        };
        
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isFirebaseReady = true;
        debugLog('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        loadResults();
        loadLeaderboard();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
        debugLog('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase: ' + error.message);
        setTimeout(initializeFirebase, 1000);
      }
    }

    // Ø¨Ø¯ÙŠÙ„ Ø¢Ù…Ù† Ù„Ù€ sessionStorage
    function getStorage(key) {
      try {
        if (typeof sessionStorage !== 'undefined') {
          return sessionStorage.getItem(key);
        } else {
          return window.tempStorage ? window.tempStorage[key] : null;
        }
      } catch (error) {
        console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© sessionStorageØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
        return window.tempStorage ? window.tempStorage[key] : null;
      }
    }

    function debugLog(message, data = null) {
      if (debugMode) {
        console.log(message, data);
        const debugDiv = document.getElementById('debugInfo');
        if (debugDiv) {
          document.getElementById('debugSection').style.display = 'block';
          debugDiv.innerHTML += `<div><strong>${new Date().toLocaleTimeString()}:</strong> ${message} ${data ? JSON.stringify(data) : ''}</div>`;
        }
      }
    }

    function goHome() {
      try {
        window.location.href = 'index.html';
      } catch (error) {
        alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ.');
      }
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${remainingSeconds} Ø«Ø§Ù†ÙŠØ©`;
    }

    function getPerformanceLevel(score, total) {
      const percentage = (score / total) * 100;
      if (percentage >= 80) return 'excellent';
      if (percentage >= 60) return 'good';
      return 'needs-improvement';
    }

    function getPerformanceMessage(score, total) {
      const percentage = (score / total) * 100;
      if (percentage >= 80) {
        return {
          title: 'ğŸ‰ Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²!',
          message: 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø­Ù‚Ù‚Øª Ù†ØªÙŠØ¬Ø© Ø±Ø§Ø¦Ø¹Ø©. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ…ÙŠØ²!'
        };
      } else if (percentage >= 60) {
        return {
          title: 'ğŸ‘ Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯',
          message: 'Ù†ØªÙŠØ¬Ø© Ø¬ÙŠØ¯Ø©! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¦Ùƒ Ø£ÙƒØ«Ø± Ù…Ø¹ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨.'
        };
      } else {
        return {
          title: 'ğŸ’ª ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù†',
          message: 'Ù„Ø§ ØªÙŠØ£Ø³! Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø³ØªÙ…Ø± Ø³ÙŠØ­Ø³Ù† Ù…Ù† Ù†ØªØ§Ø¦Ø¬Ùƒ.'
        };
      }
    }

    function loadResults() {
      debugLog('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
      const resultString = getStorage('result');
      debugLog('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:', resultString);
      
      if (resultString) {
        try {
          const result = JSON.parse(resultString);
          debugLog('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', result);
          displayResult(result);
        } catch (error) {
          debugLog('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', error);
          showDefaultResult();
        }
      } else {
        debugLog('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹');
        showDefaultResult();
      }
    }

    function displayResult(result) {
      const scoreElement = document.getElementById('yourScore');
      const timeInfoElement = document.getElementById('timeInfo');
      const timeSpentElement = document.getElementById('timeSpent');
      const performanceIndicator = document.getElementById('performanceIndicator');
      const performanceTitle = document.getElementById('performanceTitle');
      const performanceMessage = document.getElementById('performanceMessage');

      if (scoreElement) {
        const score = result.correctCount || 0;
        const total = 40;
        scoreElement.textContent = `${score} / ${total}`;
        
        // ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø©
        const level = getPerformanceLevel(score, total);
        scoreElement.className = `score ${level}`;
        
        // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡
        const performance = getPerformanceMessage(score, total);
        performanceIndicator.className = `performance-indicator ${level}`;
        performanceIndicator.style.display = 'block';
        performanceTitle.textContent = performance.title;
        performanceMessage.textContent = performance.message;
      }

      if (result.timeSeconds && timeInfoElement && timeSpentElement) {
        timeSpentElement.textContent = formatTime(result.timeSeconds);
        timeInfoElement.style.display = 'block';
      }

      debugLog('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', {
        score: result.correctCount,
        time: result.timeSeconds,
        level: getPerformanceLevel(result.correctCount || 0, 40)
      });
    }

    function showDefaultResult() {
      const scoreElement = document.getElementById('yourScore');
      const descriptionElement = document.getElementById('scoreDescription');
      
      if (scoreElement) {
        scoreElement.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
        scoreElement.className = 'score';
      }
      
      if (descriptionElement) {
        descriptionElement.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø©';
      }
      
      debugLog('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
    }

    function loadLeaderboard() {
      if (!isFirebaseReady) {
        debugLog('Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø²ØŒ Ø³Ø£Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹...');
        setTimeout(loadLeaderboard, 1000);
        return;
      }

      debugLog('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù...');
      
      try {
        db.collection('results')
          .where('weekId', '==', 'week1')
          .orderBy('correctCount', 'desc')
          .orderBy('timeSeconds', 'asc')
          .limit(3)
          .get()
          .then(snapshot => {
            const leaderboardLoading = document.getElementById('leaderboardLoading');
            const leaderboardList = document.getElementById('top3');
            const leaderboardError = document.getElementById('leaderboardError');
            
            if (leaderboardLoading) leaderboardLoading.style.display = 'none';
            
            if (!snapshot.empty) {
              if (leaderboardList) {
                leaderboardList.innerHTML = '';
                leaderboardList.style.display = 'block';
                
                snapshot.forEach((doc, idx) => {
                  const data = doc.data();
                  const li = document.createElement('li');
                  li.textContent = `${idx + 1}. ${data.studentName || 'Ø·Ø§Ù„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„'} â€“ ${data.correctCount || 0}/40 â€“ ${data.timeSeconds || 0} Ø«`;
                  leaderboardList.appendChild(li);
                });
                
                debugLog('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù:', snapshot.size + ' Ø·Ù„Ø§Ø¨');
              }
            } else {
              if (leaderboardError) {
                leaderboardError.style.display = 'block';
                leaderboardError.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
              }
              debugLog('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù');
            }
          })
          .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù:', error);
            debugLog('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù:', error.message);
            
            const leaderboardLoading = document.getElementById('leaderboardLoading');
            const leaderboardError = document.getElementById('leaderboardError');
            
            if (leaderboardLoading) leaderboardLoading.style.display = 'none';
            if (leaderboardError) leaderboardError.style.display = 'block';
          });
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù:', error);
        debugLog('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù:', error.message);
      }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('load', function() {
      debugLog('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
      loadResults(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹
      setTimeout(initializeFirebase, 500); // ØªÙ‡ÙŠØ¦Ø© Firebase Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù
    });

    // Ø¥ØªØ§Ø­Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
    window.goHome = goHome;
  </script>
</body>
</html>
